#!/usr/bin/env ruby

require 'pathname'
require 'fileutils'

DOTFILES = File.join(File.dirname(Pathname.new(__FILE__).realpath))
HOME = ENV['HOME']

Dir.chdir(DOTFILES)

puts "Creating symlinks in #{HOME} from #{DOTFILES}"

# Recursively locate .symlink/.dsymlink entries anywhere in the repository
Dir.glob('**/*.{symlink,dsymlink}', File::FNM_DOTMATCH).sort.each do |f|
  next if f.start_with?('.git/') || f.include?('/.git/')

  pathname = Pathname.new(f)
  dir = pathname.dirname      # e.g., Pathname("config") or Pathname(".")
  base = pathname.basename    # e.g., Pathname("nvim.dsymlink") or Pathname("bash_profile.symlink")
  name_without_symlink = base.basename('.*') # e.g., Pathname("nvim") or Pathname("bash_profile")

  # Absolute path to source file/dir in dotfiles repo
  src = File.join(DOTFILES, f)

  if base.extname == '.dsymlink'
    # Directory symlink: target is ~/.config/nvim or ~/.mydir
    if dir.to_s == '.'
      # Source is in root: mydir.dsymlink -> Target: ~/.mydir
      target_parent_dir = HOME
      target_name = ".#{name_without_symlink}"
    else
      # Source is in subdir: config/nvim.dsymlink -> Target: ~/.config/nvim
      target_parent_dir = File.join(HOME, ".#{dir}") # ~/.config
      target_name = name_without_symlink.to_s       # nvim
      FileUtils.mkdir_p target_parent_dir unless Dir.exist?(target_parent_dir)
    end
    dst = File.join(target_parent_dir, target_name)
  else # .symlink
    # File symlink: default target is ~/.bash_profile or ~/.vimrc
    # Link directly into HOME, prefixed with '.'
    parent_segments = pathname.each_filename.to_a[0...-1]
    target_path = nil

    parent_segments.each do |segment|
      next if segment == '.'

      if segment.end_with?('.target')
        base_segment = segment.sub(/\.target\z/, '')

        if base_segment.empty?
          warn "Skipping target override with empty name for #{f}"
          target_path = nil
          break
        end

        if target_path.nil?
          target_path =
            if base_segment.start_with?('/')
              base_segment
            elsif base_segment.start_with?('~')
              File.expand_path(base_segment, HOME)
            elsif base_segment.start_with?('.')
              File.join(HOME, base_segment)
            else
              File.join(HOME, ".#{base_segment}")
            end
        else
          target_path = File.join(target_path, base_segment)
        end
      elsif target_path
        target_path = File.join(target_path, segment)
      end
    end

    if target_path
      target_parent_dir = target_path
      FileUtils.mkdir_p(target_parent_dir) unless Dir.exist?(target_parent_dir)
      dst = File.join(target_parent_dir, name_without_symlink.to_s)
    else
      target_parent_dir = HOME
      target_name = ".#{name_without_symlink}"
      dst = File.join(target_parent_dir, target_name)
    end
  end

  # Skip if the correct symlink already exists
  if File.symlink?(dst) && File.readlink(dst) == src
    # puts "Skipping existing symlink: #{dst}" # Uncomment for verbose output
    next
  end

  puts "Symlinking #{dst} -> #{src}"
  FileUtils.ln_sf(src, dst)
end

puts "Dotfiles setup complete."
